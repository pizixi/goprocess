<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Process Manager</title>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.6.8/dist/css/layui.css">
    <script src="https://cdn.jsdelivr.net/npm/layui@2.6.8/dist/layui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->
    <link rel="stylesheet" href="/static/layui-v2.9.14/layui/css/layui.css">
    <script src="/static/layui-v2.9.14/layui/layui.js"></script>
    <script src="/static/axios/axios.min.js"></script>
    <style>
        .terminal {
            background-color: #1d1f21; /* 深色背景 */
            color: #c5c8c6; /* 淡灰色文字 */
            font-family: 'Source Code Pro', 'Monaco', 'Consolas', monospace; /* 更好的等宽字体 */
            font-size: 14px; /* 调整字体大小 */
            line-height: 1.5; /* 增加行间距 */
            padding: 20px; /* 增加内边距 */
            /* height: 550px; */
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* 自定义滚动条样式 */
        .terminal::-webkit-scrollbar {
            width: 10px; /* 定义滚动条宽度 */
        }

        .terminal::-webkit-scrollbar-track {
            background: #282a2e; /* 滚动条轨道颜色 */
        }

        .terminal::-webkit-scrollbar-thumb {
            background: #999; /* 滚动条拇指颜色 */
            border-radius: 5px; /* 滚动条拇指圆角 */
        }

        .terminal::-webkit-scrollbar-thumb:hover {
            background: #777; /* 鼠标悬停时的滚动条拇指颜色 */
        }
        .log-controls {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        .log-controls label, .log-controls div {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        .log-controls input[type="checkbox"], .log-controls input[type="number"] {
            margin-right: 5px;
        }
        .log-controls button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .log-controls button:hover {
            background-color: #45a049;
        }
        .log-controls input[type="text"], .log-controls input[type="number"] {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 5px;
        }
        #logContainer {
            font-family: monospace;
            padding: 10px;
            background-color: #1e1e1e;
            color: #d4d4d4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-line {
            white-space: pre-wrap;
            word-break: break-all;
        }


        .process-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-running { background-color: #67C23A; color: white; }
        .status-stopped { background-color: #909399; color: white; }
        .status-starting { background-color: #E6A23C; color: white; }
        .status-stopping { background-color: #F56C6C; color: white; }
        .status-error { background-color: #F56C6C; color: white; }
        .action-btn {
            margin: 2px;
        }
        #addProcessBtn {
            margin-bottom: 20px;
            background-color: #009688;
            border-color: #009688;
        }
        #addProcessBtn:hover {
            background-color: #00877a;
            border-color: #00877a;
        }

        .btn-custom {
            /* 基础颜色 */
            background-color: #2c3e50;
            color: white;

            /* 添加圆角 */
            border-radius: 15px;
            margin-top: 20px; /* 调整数值以达到期望的距离 */

            /* 添加阴影效果 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease; /* 平滑过渡效果 */

            /* 重置默认按钮边框 */
            border: none;
        }

        /* 鼠标悬停时的样式 */
        .btn-custom:hover {
            background-color: #34495e;
            transform: translateY(-2px); /* 上升效果 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* 按下按钮时的样式 */
        .btn-custom:active {
            transform: translateY(2px); /* 下沉效果 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
<div class="layui-container">
    <button class="layui-btn layui-btn-lg btn-custom" id="addProcessBtn">
        <i class="layui-icon">&#xe654;</i> Add Process
    </button>
    <table class="layui-table" id="processTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Process Name</th>
            <th>PID</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="processBody"></tbody>
    </table>
</div>

<script>
layui.use(['table', 'form', 'layer'], function() {
    const table = layui.table;
    const form = layui.form;
    const layer = layui.layer;

    let socket;

    function connectWebSocket() {
        socket = new WebSocket('ws://' + window.location.host + '/ws');
        
        socket.onopen = function(e) {
            console.log("WebSocket connection established");
        };

        socket.onmessage = function(event) {
            const process = JSON.parse(event.data);
            updateProcessStatus(process.ID, process.Status, process.PID);
        };

        socket.onclose = function(event) {
            console.log("WebSocket connection closed. Reconnecting...");
            setTimeout(connectWebSocket, 1000);
        };

        socket.onerror = function(error) {
            console.log("WebSocket error: ", error);
        };
    }

    connectWebSocket();

    function loadProcesses() {
        axios.get('/processes').then(function(response) {
            const tbody = document.getElementById('processBody');
            tbody.innerHTML = '';
            response.data.forEach(function(process) {
                const row = document.createElement('tr');
                row.id = `process-row-${process.ID}`;
                row.innerHTML = `
                    <td>${process.ID}</td>
                    <td>${process.Name}</td>
                    <td class="process-pid">${process.PID}</td>
                    <td><span class="process-status status-${process.Status.toLowerCase()}">${process.Status}</span></td>
                    <td>
                        <button class="layui-btn layui-btn-sm layui-btn-normal action-btn start-btn" onclick="startProcess(${process.ID})">
                            <i class="layui-icon">&#xe652;</i> Start
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-danger action-btn stop-btn" onclick="stopProcess(${process.ID})">
                            <i class="layui-icon">&#xe651;</i> Stop
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-primary action-btn" onclick="showLogs(${process.ID})">
                            <i class="layui-icon">&#xe60a;</i> Logs
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-warm action-btn" onclick="editProcess(${process.ID})">
                            <i class="layui-icon">&#xe642;</i> Edit
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-danger action-btn delete-btn" onclick="deleteProcess(${process.ID})">
                            <i class="layui-icon">&#xe640;</i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updateAllProcessStatuses();
        });
    }

    window.startProcess = function(id) {
        const row = document.getElementById(`process-row-${id}`);
        const status = row.querySelector('.process-status').textContent;
        if (status === 'running' || status === 'stopping' || status === 'starting') {
            layer.msg('Cannot start process. It is currently ' + status + '.', {icon: 2});
            return;
        }
        axios.post(`/process/${id}/start`).then(function(response) {
            updateProcessStatus(id, response.data.status);
        });
    }

    window.stopProcess = function(id) {
        const row = document.getElementById(`process-row-${id}`);
        const status = row.querySelector('.process-status').textContent;
        if (status === 'stopped' || status === 'stopping') {
            layer.msg('Cannot stop process. It is currently ' + status + '.', {icon: 2});
            return;
        }
        axios.post(`/process/${id}/stop`).then(function(response) {
            updateProcessStatus(id, response.data.status);
        });
    }

    window.deleteProcess = function(id) {
    const row = document.getElementById(`process-row-${id}`);
    const status = row.querySelector('.process-status').textContent;
    if (status === 'running') {
        layer.msg('Cannot delete process. You must stop the service first.', {icon: 2});
        return;
    }
    // 弹框确认删除,点 确定后执行删除操作
    layer.confirm('Are you sure you want to delete this process?', {
        title: 'Delete Confirmation', // 添加标题
        btn: ['Yes', 'No']
    }, function(index) {
        axios.delete(`/process/${id}`).then(function(response) {
            loadProcesses();
            layer.close(index); // 使用返回的索引值来关闭对话框
        });
    });
}

    function updateProcessStatus(id, status, pid) {
        const row = document.getElementById(`process-row-${id}`);
        if (row) {
            const statusElement = row.querySelector('.process-status');
            const pidElement = row.querySelector('.process-pid');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const deleteButton = row.querySelector('.delete-btn');

            if (statusElement) {
                statusElement.className = `process-status status-${status.toLowerCase()}`;
                statusElement.textContent = status;
            }

            if (pidElement) {
                pidElement.textContent = pid || 0;
            }
            
            if (startButton && stopButton && deleteButton) {
                // startButton.disabled = (status === 'running' || status === 'stopping' || status === 'starting');
                // stopButton.disabled = status !== 'running';
                // deleteButton.disabled = status === 'running';
            }
        }
    }

    function updateAllProcessStatuses() {
        const rows = document.querySelectorAll('[id^="process-row-"]');
        rows.forEach(row => {
            const id = row.id.split('-')[2];
            const status = row.querySelector('.process-status').textContent;
            const pid = row.querySelector('.process-pid').textContent;
            updateProcessStatus(id, status, pid);
        });
    }

    window.showLogs = function(id) {
        let source;
        let MAX_LINES = 800; // 默认值设为 800
        
        axios.get(`/processes/${id}`).then(function(response) {
            const process = response.data;
            let logLayer = layer.open({
                type: 1,
                title: `Process Logs - ${process.Name}`,
                area: ['90%', '80%'],
                shadeClose: true,
                moveType: 1,
                maxmin: true,
                content: `
                    <div id="logWrapper" style="display: flex; flex-direction: column; height: 100%;">
                        <div class="log-controls">
                            <label><input type="checkbox" id="autoScroll" checked> Auto-scroll</label>
                            <button id="clearLogs">Clear Logs</button>
                            <div style="margin-left: 20px;">
                                <label for="maxLines"> Max Lines:</label>
                                <input type="number" id="maxLines" value="800" min="100" step="100">
                            </div>
                            <input type="text" id="filterLogs" placeholder="Filter logs...">
                        </div>
                        <div id="logContainer" class="terminal" style="flex-grow: 1; overflow-y: auto;"></div>
                    </div>
                `,
                success: function(layero, index) {
                    const logContainer = document.getElementById('logContainer');
                    const autoScrollCheckbox = document.getElementById('autoScroll');
                    const clearLogsButton = document.getElementById('clearLogs');
                    const filterLogsInput = document.getElementById('filterLogs');
                    const maxLinesInput = document.getElementById('maxLines');

                    // 动态设置高度
                    logContainer.style.height = (layero.height() - layero.find('.layui-layer-title').outerHeight() - layero.find('.log-controls').outerHeight()) + 'px';

                    let logLines = [];

                    function updateLogDisplay() {
                        logContainer.textContent = logLines.join('\n');
                        if (autoScrollCheckbox.checked) {
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }

                    function trimLogLines() {
                        while (logLines.length > MAX_LINES) {
                            logLines.shift(); // 移除最旧的一行
                        }
                    }

                    maxLinesInput.onchange = function() {
                        MAX_LINES = parseInt(this.value, 10);
                        trimLogLines();
                        updateLogDisplay();
                    };

                    source = new EventSource(`/process/${id}/logstream`);
                    source.onmessage = function(event) {
                        const logLine = event.data;
                        if (!filterLogsInput.value || logLine.includes(filterLogsInput.value)) {
                            logLines.push(logLine);
                            trimLogLines();
                            updateLogDisplay();
                        }
                    };

                    source.addEventListener('error', function(event) {
                        logLines.push('<span style="color: #ff6b6b;">Error: ' + event.data + '</span>');
                        trimLogLines();
                        updateLogDisplay();
                        source.close();
                    });

                    source.onerror = function(error) {
                        console.error('EventSource failed:', error);
                        logLines.push('<span style="color: #ff6b6b;">Connection error. Please try again later.</span>');
                        trimLogLines();
                        updateLogDisplay();
                        source.close();
                    };

                    clearLogsButton.onclick = function() {
                        logLines = [];
                        updateLogDisplay();
                    };

                    filterLogsInput.oninput = function() {
                        const filter = this.value;
                        const filteredLines = logLines.filter(line => line.includes(filter));
                        logContainer.textContent = filteredLines.join('\n');
                    };
                },
                end: function() {
                    if (source) {
                        source.close();
                    }
                }
            });
        }).catch(function(error) {
            console.error('Error fetching process details:', error);
            layer.msg('Error fetching process details', {icon: 2});
        });
    }

    window.editProcess = function(id) {
        axios.get(`/processes/${id}`).then(function(response) {
            const process = response.data;
            layer.open({
                type: 1,
                title: 'Edit Process',
                area: ['650px', '500px'],
                content: `
                    <form class="layui-form" id="editProcessForm" style="padding: 20px;">
                        <div class="layui-form-item">
                            <label class="layui-form-label">Name</label>
                            <div class="layui-input-block">
                                <input type="text" name="Name" required lay-verify="required" placeholder="Enter Name" class="layui-input" value="${process.Name}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">Command</label>
                            <div class="layui-input-block">
                                <input type="text" name="Command" required lay-verify="required" placeholder="Enter Command" class="layui-input" value="${process.Command}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">WorkDir</label>
                            <div class="layui-input-block">
                                <input type="text" name="WorkDir" placeholder="Enter WorkDir" class="layui-input" value="${process.WorkDir}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">User</label>
                            <div class="layui-input-block">
                                <input type="text" name="User" placeholder="Enter User" class="layui-input" value="${process.User}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">RetryCount</label>
                            <div class="layui-input-block">
                                <input type="number" name="RetryCount" required lay-verify="required" placeholder="Enter RetryCount" class="layui-input" value="${process.RetryCount}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">AutoStart</label>
                            <div class="layui-input-block">
                                <input type="checkbox" name="AutoStart" lay-skin="switch" lay-text="ON|OFF" ${process.AutoStart ? 'checked' : ''}>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="editProcessForm">Save</button>
                                <button type="button" class="layui-btn layui-btn-primary" id="closeBtn">Close</button>
                            </div>
                        </div>
                    </form>
                `
            });
            form.render();
            // 为关闭按钮添加点击事件
            document.getElementById('closeBtn').addEventListener('click', function() {
                layer.closeAll();
            });

            form.on('submit(editProcessForm)', function(data) {
                data.field.RetryCount = parseInt(data.field.RetryCount, 10);
                data.field.AutoStart = data.field.AutoStart === 'on';
                axios.put(`/process/${id}`, data.field).then(function() {
                    layer.closeAll();
                    loadProcesses();
                });
                return false;
            });
        });
    }

    document.getElementById('addProcessBtn').addEventListener('click', function() {
        layer.open({
            type: 1,
            title: 'Add Process',
            area: ['650px', '500px'],
            content: `
                <form class="layui-form" id="addProcessForm" style="padding: 20px;">
                    <div class="layui-form-item">
                        <label class="layui-form-label">Name</label>
                        <div class="layui-input-block">
                            <input type="text" name="Name" required lay-verify="required" placeholder="Enter Name" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">Command</label>
                        <div class="layui-input-block">
                            <input type="text" name="Command" required lay-verify="required" placeholder="Enter Command" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">WorkDir</label>
                        <div class="layui-input-block">
                            <input type="text" name="WorkDir" placeholder="Enter WorkDir" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">User</label>
                        <div class="layui-input-block">
                            <input type="text" name="User" placeholder="Enter User" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">RetryCount</label>
                        <div class="layui-input-block">
                            <input type="number" name="RetryCount" required lay-verify="required" placeholder="Enter RetryCount" class="layui-input" value="3">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">AutoStart</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="AutoStart" lay-skin="switch" lay-text="ON|OFF">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="addProcessForm">Add</button>
                            <button type="button" class="layui-btn layui-btn-primary" id="closeBtn">Close</button>
                        </div>
                    </div>
                </form>
            `
        });
        form.render();
        // 为关闭按钮添加点击事件
        document.getElementById('closeBtn').addEventListener('click', function() {
            layer.closeAll();
        });

        form.on('submit(addProcessForm)', function(data) {
            data.field.RetryCount = parseInt(data.field.RetryCount, 10);
            data.field.AutoStart = data.field.AutoStart === 'on';
            axios.post('/process', data.field).then(function() {
                layer.closeAll();
                loadProcesses();
            });
            return false;
        });
    });

    loadProcesses();
});
</script>
</body>
</html>